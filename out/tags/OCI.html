<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>
  <head>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
    <title>Tagged: OCI</title>
    <link rel='stylesheet' type='text/css' href='/bootstrap.css' />
    <link rel='stylesheet' type='text/css' href='/custom.css' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <script src='//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
    <script src='/post.js'></script>
  </head>
<body>

  <div class='navbar navbar-inverse navbar-fixed-top'>
    <div class='navbar-inner'>
      <div class='container'>
        <ul class='nav'>
          <li><a href='/'>Blog</a></li>
          <li><a href='/misc.html'>Miscellany</a></li>
          <li><a href='/music.html'>Music</a></li>
        </ul>
        <ul class='nav' style='float: right;'>
          <li><a href='/archives'>Archives</a></li>
          <li><a href='/tags'>Tags</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div id='content' class='container' style='padding-top: 50px;'><div class='page well'>
  <h2 class='title'>stacker: build OCI images without host privilege</h2>
  <p class='byline'>
    <small>Posted by <span class='author'>tycho</span> on <span class='date'>2018-01-28</span></small>
  </p>
  <div class='content'><p>Ahoy! Recently, I've been working on a tool called <a href='http://github.com/anuvu/stacker'>stacker</a>, which allows unprivileged users to build OCI images. The images that are generated are generated without uid shifting, so they look like any other OCI image that was generated by Docker or some other mechanism, while not requiring root (worth noting that this is what James Bottomley has described as his motivation for writing <a href='https://lkml.org/lkml/2017/2/20/653'>shiftfs</a>).</p>
<p>Some base setup is required in order to make this happen, though. First, you can follow <a href='https://github.com/anuvu/stacker#install'>stacker's install guide</a> to build and install it.</p>
<p>Next, as with any user namespaces setup, stacker needs a 65k uid delegation. On my ubuntu VM with the ubuntu user, this looks like,</p>
<pre><code>$ grep ubuntu /etc/subuid
ubuntu:165536:65536
$ grep ubuntu /etc/subgid
ubuntu:165536:65536</code></pre>
<p>Note that these can be any 65k range of subuids, stacker will use whatever you give the user you run it as.</p>
<p>Finally, stacker also needs a btrfs filesystem. Stacker was designed to build a large number of varying images from a single base image, and uses btrfs to avoid doing a large amount of i/o (and compression/decompression), undiffing filesystems back to their original state. For the purposes of this blog post, we can just use a loopback mounted btrfs filesystem. A slightly modified excerpt from the stacker test suite:</p>
<pre><code># btrfs setup
sudo truncate -s 100G btrfs.loop
sudo mkfs.btrfs btrfs.loop
sudo mkdir -p roots
# allow for unprivileged subvolume deletion; use a sane flushing strategy
sudo mount -o user_subvol_rm_allowed,flushoncommit,loop .stacker/btrfs.loop roots
# now make sure ubuntu can actually do stuff with this filesystem
sudo chown -R ubuntu:ubuntu roots</code></pre>
<p>And with that, we can actually run stacker and build an image:</p>
<pre><code>stacker build -f ./stacker.yaml</code></pre>
<p>What goes in <code>stacker.yaml</code> you ask? Consider the example from stacker's readme:</p>
<pre><code>centos:
	from:
		type: tar
		url: http://example.com/centos.tar.gz
	environment:
		http_proxy: http://example.com:8080
		https_proxy: https://example.com:8080
	labels:
		foo: bar
		bar: baz
boot:
	from:
		type: built
		tag: centos
	run: |
		yum install openssh-server
		echo meshuggah rocks
web:
	from:
		type: built
		tag: centos
	import: ./lighttp.cfg
	run: |
		yum install lighttpd
		cp /stacker/lighttp.cfg /etc/lighttpd/lighttp.cfg
	entrypoint: lighthttpd
	volumes:
		- /data/db
	working_dir: /var/lib/www</code></pre>
<p>The top level describes the name of a tag in the OCI image to be built, in this case there will be three tags at the end: <code>centos</code>, <code>boot</code>, and <code>web</code> (notably, this example is quite contrived :). Underneath those, there are the following keys:</p>
<h1>. <code>from</code>: this describes the base image that stacker will start from. You can</h1>
<p>either start from some other image in the same stackerfile, a Docker image, or a tarball.</p>
<h1>. <code>import</code>: A set of files to download or copy into the container. Stacker</h1>
<p>will put these files at <code>/stacker</code>, which will be automatically cleaned up after the commands in the <code>run</code> section are run and the image is finalized.</p>
<h1>. <code>run</code>: This is the set of commands to run in order to build the image; they</h1>
<p>are run in a user namespaced container, with the set of files imported available in <code>/stacker</code>.</p>
<h1>. <code>environment</code>, <code>labels</code>, <code>working_dir</code>, <code>volumes</code>: these all correspond</h1>
<p>exactly to the similarly named bits in the <a href='https://github.com/opencontainers/image-spec/blob/master/config.md#properties'>OCI image config spec</a>, and are available for users to pass things through to the runtime environment of the image.</p>
<p>That's a bit about stacker. Hopefully some more details about the internals will appear at some point :). Happy hacking!</p></div>
  <div class='meta'>
    <p class='links'>
      <span class='tags'>Tags: <a href='/tags/linux.html' class='tag'>linux, </a><a href='/tags/OCI.html' class='tag'>OCI, </a><a href='/tags/containers.html' class='tag'>containers, </a><a href='/tags/golang.html' class='tag'>golang</a></span>
       •   <a href='/blog/2018/stacker.html' class='more'>Read full post »</a>
    </p>
  </div>
</div></div>
</body>
</html>
